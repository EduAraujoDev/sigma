{% extends "base_layout.twig" %}
{% block title %}Novo Marca{% endblock %}
{% block content_header %}
    <section class="content-header">
        <h1>
            Área Administrador
            <small>Novo Orçamento</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
            <li class="active">Novo Orçamento</li>
        </ol>
    </section>
{% endblock %}
{% block content %}
    <section class="content">
        <div class="col-md-12">
            <div class="box box-primary">
                <div class="box-header with-border">
                    <h3 class="box-title">Dados do Oçamento</h3>
                </div>
                <form class="form-horizontal" role="form" action="{{base_url}}orcamento/adicionar" method="post" method="post">
                    <div class="box-body">
                        <div class="form-group">
                            <div class="col-xs-12 col-sm-3 col-md-3" >
                                <label for="login">Código</label>
                                <input type="text" class="form-control" name="codOrcamento" id="codOrcamento" placeholder="Digite o Código" maxlength="80">
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3">
                                <label for="exampleInputEmail1">Status</label>
                                <select class="form-control" name="Status">
                                    <option value="1">Aberto</option>
                                    <option value="2">Reprovado</option>
                                    <option value="3">Reprovado e Pendente Pagamento</option>
                                    <option value="4">Reprovado e Pago</option>
                                    <option value="5">Reprovado e Não Pago</option>
                                    <option value="6">Aprovado</option>
                                </select>
                            </div>
                            <div class="col-xs-12 col-sm-3 col-md-3" >
                                <label for="login">Data Criação</label>
                                <input type="text" class="form-control" name="dataCriacao" id="dataCriacao" disabled>
                            </div>                          
                            <div class="col-xs-12 col-sm-3 col-md-3" >
                                <label for="login">Data de finalização</label>
                                <input type="text" class="form-control" name="dataFinalizacao" id="dataFinalizacao" placeholder="  /  /    " >
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12 col-sm-12 col-md-2">
                                <label for="complemento">Código do Cliente</label>                            
                                <div class="input-group">
                                    <input type="text" class="form-control" name="codCliente" id="codCliente" placeholder="Código do Cliente" disabled>
                                    <span class="input-group-btn">
                                        <button type="button" class="btn btn-info btn-flat" onclick="buscaCliente();"><i class="fa fa-search"></i></button>
                                    </span>
                                </div>
                            </div>
                            <div class="col-xs-12 col-sm-12 col-md-10">
                                <label for="complemento">Nome do Cliente</label>
                                <input type="text" class="form-control" name="nomeCliente" id="nomeCliente" placeholder="Nome do Cliente" disabled>
                            </div>  
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12 col-sm-12 col-md-12">
                                <label for="complemento">Obervações</label>
                                <br>
                                <textarea class="form-control" name="observacoes" rows="3" placeholder=""></textarea>
                            </div>  
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12 col-sm-12 col-md-12">
                                <label for="complemento">Serviços</label>
                                <table id="servicos" class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th class="text-center">Código</th>
                                            <th class="text-center">Descrição</th>
                                            <th class="text-center">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-2 col-md-offset-5"> 
                                <label for="totalServico" style="padding-top: 6px; padding-left: 12px">Total de Serviços(R$):</label>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control text-right" name="totalServico" id="totalServico" value="0,00" disabled>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-info btn-flat" onclick="buscaServico();">Incluir Serviço</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-xs-12 col-sm-12 col-md-12">
                                <label for="complemento">Produtos</label>
                                <table id="produtos" class="table table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th class="text-center">Código</th>
                                            <th class="text-center">Descrição</th>
                                            <th class="text-center">Quantidade</th>
                                            <th class="text-center">Desconto</th>
                                            <th class="text-center">Preço venda</th>
                                            <th class="text-center">Subtotal Bruto</th>
                                            <th class="text-center">Subtotal Liquido</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-2 col-md-offset-5"> 
                                <label for="totalProduto" style="padding-top: 6px; padding-left: 7px">Total de Produtos(R$):</label>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control text-right" name="totalProduto" id="totalProduto" value="0,00" disabled>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-info btn-flat" onclick="buscaProduto();">Incluir Produto</button>
                            </div>
                        </div>
                    </div>
                    <div class="box-footer">
                        <button type="submit" class="btn btn-success">Cadastrar</button>
                        <a href="{{base_url}}orcamento/listar"><button type="button" class="btn btn-danger">Cancelar</button></a>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <div class="modal fade" id="modal_cliente" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Escolha o cliente</h3>
                    <p>Clique duas vezes para escolher o cliente</p>
                </div>
                <div class="modal-body form">
                    <table id="tabelaCliente" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Nome</th>
                                <th>Cpf/Cnpj</th>
                                <th>E-Mail</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>            
                    </table>                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal_servico" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Escolha o Serviço</h3>
                    <p>Clique duas vezes para escolher o Serviço</p>
                </div>
                <div class="modal-body form">
                    <table id="tabelaServico" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Titulo</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>            
                    </table>                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal_produto" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Escolha o Produto</h3>
                    <p>Clique duas vezes para escolher o Produto</p>
                </div>
                <div class="modal-body form">
                    <table id="tabelaProduto" class="table table-striped table-bordered table-hover" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Descrição</th>
                                <th>Estoque</th>
                                <th>Valor (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>            
                    </table>                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>    
{% endblock %}
{% block js %}
    {{ parent() }}
    <script type="text/javascript">
        window.onload=function(){
            var dataAtual = new Date();
            var dia = dataAtual.getDate();
            var mes = dataAtual.getMonth()+1;
            var ano = dataAtual.getFullYear();

            dia = dia.toString().length == 1?"0"+dia:dia;                    
            mes = mes.toString().length == 1?"0"+mes:mes;

            $("#dataCriacao").datepicker({dateFormat: 'dd/mm/yy', language: 'pt-BR'});
            $("#dataCriacao").val([dia, mes, ano ].join("/"));

            $("#dataFinalizacao").datepicker({dateFormat: 'dd/mm/yy', language: 'pt-BR'});
            $("#dataFinalizacao").val([dia, mes, ano ].join("/"));

            $("#totalProduto").maskMoney({thousands:'.', decimal:','});
            $("#totalServico").maskMoney({thousands:'.', decimal:','});
        };

        function buscaCliente(){            
            tableCliente = $('#tabelaCliente').DataTable({
                "order": [],
         
                "ajax": {
                    "url": "{{base_url}}cliente/ajax_cliente",
                    "type": "POST"
                },
            });

            $('#modal_cliente').modal('show');            
        }

        $('#tabelaCliente tbody').on( 'click', 'tr', function () {
            var dadosLinha = tableCliente.row(this).data();

            document.querySelector("#codCliente").value = dadosLinha[0];
            document.querySelector("#nomeCliente").value = dadosLinha[1];

            $('#modal_cliente').modal('hide');
            tableCliente.destroy();
        });

        function buscaServico(){
            tableServico = $('#tabelaServico').DataTable({
                "order": [],
         
                "ajax": {
                    "url": "{{base_url}}servico/ajax_servico",
                    "type": "POST"
                },
                "aoColumns": [
                    {"Id": "Id", "sClass": "text-left"},
                    {"Titulo": "Titulo", "sClass": "text-left"},
                    {"Descricao": "Descricao", "sClass": "text-left"},
                    {"Valor": "Valor", "sClass": "text-right"},
                ]
            });

            $('#modal_servico').modal('show');          
        }

        $('#tabelaServico tbody').on( 'click', 'tr', function () {
            var tabelaServico   = document.querySelector("#servicos");
            var vlrTotalServico = $("#totalServico").maskMoney('unmasked')[0];
            var dadosLinha      = tableServico.row(this).data();
            var numLinha        = tabelaServico.rows.length;
            var row             = tabelaServico.insertRow(numLinha);
            var vlrServico      = 0;

            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);

            cell1.innerHTML = cell1.innerHTML + numLinha;
            cell2.innerHTML = cell2.innerHTML + dadosLinha[1];
            cell3.innerHTML = cell3.innerHTML + dadosLinha[2];
            cell4.innerHTML = cell4.innerHTML + dadosLinha[3];

            cell4.setAttribute('class', 'text-right');

            $('#modal_servico').modal('hide');
            tableServico.destroy();

            vlrServico = dadosLinha[3].replace(".", "");
            vlrServico = vlrServico.replace(",", '.');
            vlrServico = parseFloat(vlrServico);

            vlrTotalServico += vlrServico;          

            $('#totalServico').maskMoney('mask', vlrTotalServico);
        });

        function buscaProduto(){
            tableProduto = $('#tabelaProduto').DataTable({
                "order": [],
         
                "ajax": {
                    "url": "{{base_url}}produto/ajax_produto",
                    "type": "POST"
                },
                "aoColumns": [
                    {"Id": "Id", "sClass": "text-left"},
                    {"Descricao": "Descricao", "sClass": "text-left"},
                    {"Estoque": "Estoque", "sClass": "text-right"},
                    {"Valor": "Valor", "sClass": "text-right"},
                ]                
            });

            $('#modal_produto').modal('show');          
        }

        $('#tabelaProduto tbody').on( 'click', 'tr', function () {
            var tabelaProduto   = document.querySelector("#produtos");
            var vlrTotalProduto = $("#totalProduto").maskMoney('unmasked')[0];
            var dadosLinha      = tableProduto.row(this).data();
            var numLinha        = tabelaProduto.rows.length;
            var row             = tabelaProduto.insertRow(numLinha);
            var vlrProduto      = 0;

            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);            
            var cell5 = row.insertCell(4);            
            var cell6 = row.insertCell(5);            
            var cell7 = row.insertCell(6);            
            var cell8 = row.insertCell(7);            

            cell1.innerHTML = cell1.innerHTML + numLinha;
            cell2.innerHTML = cell2.innerHTML + dadosLinha[0];
            cell3.innerHTML = cell3.innerHTML + dadosLinha[1];
            cell4.innerHTML = cell4.innerHTML + 1;            
            cell5.innerHTML = cell5.innerHTML + 0;
            cell6.innerHTML = cell6.innerHTML + dadosLinha[3];            
            cell7.innerHTML = cell7.innerHTML + dadosLinha[3];            
            cell8.innerHTML = cell8.innerHTML + dadosLinha[3];

            cell4.setAttribute('class', 'text-right');
            cell5.setAttribute('class', 'text-right');
            cell6.setAttribute('class', 'text-right');
            cell7.setAttribute('class', 'text-right');

            $('#modal_produto').modal('hide');
            tableProduto.destroy();

            vlrProduto = dadosLinha[3].replace(".", "");
            vlrProduto = vlrProduto.replace(",", '.');
            vlrProduto = parseFloat(vlrProduto);

            vlrTotalProduto += vlrProduto;          

            $('#totalProduto').maskMoney('mask', vlrTotalProduto);
        });        
    </script>
{% endblock %}